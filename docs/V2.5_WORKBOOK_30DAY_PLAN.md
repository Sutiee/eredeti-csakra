# V2.5 - 30 Napos Csakra Munkafüzet Generálás

**Created:** 2025-10-22
**Status:** Implementation Phase
**Goal:** Személyre szabott 30 napos munkafüzet generálása GPT-5-mini + PDF-el vásárláskor

---

## 📋 Feature Overview

### Termék: 30 Napos Csakra Munkafüzet
- **Ár:** 3,990 HUF (eredeti 9,990 HUF, 60% kedvezmény)
- **Tartalom:** 30-40 oldalas PDF személyre szabott gyakorlatokkal
- **Generálás:** Vásárláskor automatikusan (Stripe webhook trigger)
- **Technológia:** GPT-5-mini (2 API hívás) + @react-pdf/renderer
- **Delivery:** Success page-en polling-al, PDF download link

---

## 🎯 Döntések (User által jóváhagyva)

### 1. Csakra Elosztás
**Opció B - Személyre szabott (user score alapján)**
- Blokkolt csakrák (score 4-7): **6-7 nap**
- Kiegyensúlyozatlan (score 8-12): **4-5 nap**
- Egészséges (score 13-16): **2-3 nap**

### 2. Napi Tartalom
**Opció B - Gazdag verzió (20-30 perc/nap)**
```
✓ Nap száma + csakra (színes fejléc)
✓ Napi szándék/fókusz (1 mondat)
✓ Elméleti háttér (MIÉRT fontos - 2-3 mondat)
✓ Részletes gyakorlat (4-5 lépés: HOL, MIKOR, HOGYAN)
✓ 3-5 journaling kérdés (önreflexió)
✓ Affirmációk (2-3 mondat)
✓ Motivációs zárás
```

### 3. Heti Értékelés
**Opció C - Folyamatos tracking**
- Minden napi oldalon checkbox (☐ Megtörtént)
- Nincs külön heti értékelő lap
- User maga összegzi heti szinten

### 4. Personalizáció
**Szint 2 - Közepesen személyre szabott**
- Nap-elosztás személyre szabott (több nap blokkolt csakráknak)
- Bevezető oldal utal user score-ra
- Gyakorlatok általánosak, de hangsúlyok eltérnek
- Gyorsabb generálás, kevesebb token

### 5. GPT-5 Stratégia
**Opció B - Két API hívás**
- 1. hívás: Nap 1-15
- 2. hívás: Nap 16-30
- Költség: ~$0.08-0.10/munkafüzet
- Generálási idő: ~48-50 másodperc

### 6. Meditációk
**Opció A - PDF-ben teljes script**
- Minden csakránál teljes 15-20 perces meditációs szöveg
- +7 oldal (összesen 37-40 oldal PDF)
- Újrafelhasználás: `data/meditation-scripts.ts`

### 7. Ár & Bundle
**3,990 HUF - NINCS bundle**
- Standalone termék
- Upsell sorrend: 990 Ft AI Elemzés → 3,990 Ft Munkafüzet
- Meditációk külön termék (később)

---

## 🏗️ Architektúra

### Data Flow
```
User vásárol (Stripe)
    ↓
Webhook trigger → POST /api/generate-workbook
    ↓
1. Fetch quiz_results (csakra score-ok)
    ↓
2. Calculate personalized day distribution
    ↓
3. GPT-5 hívás #1: Nap 1-15 generálás (~20s)
    ↓
4. GPT-5 hívás #2: Nap 16-30 generálás (~20s)
    ↓
5. Combine results + add meditation scripts
    ↓
6. Generate PDF with @react-pdf/renderer (~5s)
    ↓
7. Upload to Supabase Storage (workbooks bucket)
    ↓
8. Create signed URL (30 days expiry)
    ↓
9. Update purchases.pdf_url
    ↓
Success page: polling → Download gomb megjelenik
```

### Token Usage (per workbook)
```
Input:  6,000 tokens (~$0.003)
Output: 8,000 tokens (~$0.08)
TOTAL:  ~$0.083/workbook
```

### Generation Time
```
1. Fetch quiz result:          ~500ms
2. GPT-5 #1 (Days 1-15):        ~20s
3. GPT-5 #2 (Days 16-30):       ~20s
4. PDF generation:              ~5s
5. Upload + signed URL:         ~3s
TOTAL:                          ~48-50s
```

---

## 📁 Új Fájlok (7 db)

### 1. `lib/openai/workbook-generator-gpt5.ts`
**Felelősség:** GPT-5 orchestration
```typescript
- generateWorkbookContent(chakraScores, userName)
- generateWorkbookDays1to15()
- generateWorkbookDays16to30()
- calculateDaysPerChakra(chakraScores)
- combineDayContent()
```

### 2. `lib/openai/workbook-prompts-gpt5.ts`
**Felelősség:** Prompt builders
```typescript
- buildWorkbookPrompt(chakraScores, userName, dayRange, distribution)
```

### 3. `lib/openai/workbook-schemas-gpt5.ts`
**Felelősség:** Zod validation
```typescript
- WorkbookDaySchema
- WorkbookDaysResponseSchema (15 days)
- Type exports: WorkbookDay, WorkbookDaysResponse
```

### 4. `lib/pdf/workbook-template-gpt5.ts`
**Felelősség:** PDF generation
```typescript
- generateWorkbookPDF(days, chakraScores, userName, meditations)
- addCoverPage()
- addIntroductionPage()
- addDayPage(day)
- addMeditationScriptPage(chakra)
- addClosingPage()
```

### 5. `app/api/generate-workbook/route.ts`
**Felelősség:** API endpoint
```typescript
POST /api/generate-workbook
Input: { result_id: string }
Output: { data: { success, pdf_url }, error }
```

### 6. `supabase/migrations/00X_workbooks_bucket.sql`
**Felelősség:** Storage setup
```sql
- Create workbooks bucket
- RLS policies (public read, service upload)
```

### 7. `docs/V2.5_WORKBOOK_30DAY_PLAN.md` ✅
**Felelősség:** Ez a dokumentum

---

## 🔧 Módosított Fájlok (2 db)

### 1. `app/api/stripe/webhook/route.ts`
**Változás:** +10 sor (workbook trigger)
```typescript
// Line 151 után:
if (productId === 'workbook_30day') {
  fetch(`${SITE_URL}/api/generate-workbook`, {
    method: 'POST',
    body: JSON.stringify({ result_id: resultId }),
  });
}
```

### 2. `components/success/DownloadLinks.tsx`
**Változás:** +15 sor (workbook polling + display)
```typescript
// hasGeneratingPDFs check:
const hasGeneratingPDFs = purchases.some(
  (p) => (p.product_id === 'ai_analysis_pdf' || p.product_id === 'workbook_30day') && !p.pdf_url
);

// PDF display:
if (purchase.product_id === 'workbook_30day' && purchase.pdf_url) {
  return <a href={purchase.pdf_url}>📖 30 Napos Munkafüzet letöltése</a>;
}
```

---

## 📖 PDF Struktúra (37-40 oldal)

```
Oldal 1:    Borító (Cím, User neve, Dátum)
Oldal 2:    Bevezető (Személyre szabott üzenet score alapján)
Oldal 3-32: Napi oldalak (30 nap × gyakorlatok)
Oldal 33:   Gyökércsakra meditációs script
Oldal 34:   Szakrális csakra meditációs script
Oldal 35:   Napfonat csakra meditációs script
Oldal 36:   Szív csakra meditációs script
Oldal 37:   Torok csakra meditációs script
Oldal 38:   Harmadik szem meditációs script
Oldal 39:   Korona csakra meditációs script
Oldal 40:   Záró oldal (Gratulálás, Következő lépések)
```

### Napi Oldal Layout
```
┌─────────────────────────────────────┐
│ [Csakra Színes Csík]                │
│ 15. NAP - TOROK CSAKRA              │
├─────────────────────────────────────┤
│ 🎯 Napi Szándék:                    │
│ "Ma megtanulom hitelesen..."        │
├─────────────────────────────────────┤
│ 💡 Miért fontos?                    │
│ "A Torok csakra a hitelesség..."    │
├─────────────────────────────────────┤
│ ✨ Mai Gyakorlat:                   │
│ 1. Reggel felkelve...               │
│ 2. Munka közben...                  │
│ 3. Este lefekvés előtt...           │
├─────────────────────────────────────┤
│ 📝 Journaling Kérdések:             │
│ • Mikor hallgattam el magam?        │
│ • Mit szeretnék kimondani?          │
│ • Hogyan éreztem magam...?          │
├─────────────────────────────────────┤
│ 💬 Napi Affirmáció:                 │
│ "Szabadon és hitelesen kifejezem    │
│  magam. A hangom fontos."           │
├─────────────────────────────────────┤
│ ☐ Reggeli gyakorlat elvégezve       │
│ ☐ Journaling befejezve              │
│ ☐ Affirmáció 3× elmondva            │
├─────────────────────────────────────┤
│ 🌟 "Emlékezz: minden szavad számít" │
└─────────────────────────────────────┘
```

---

## 🧪 Tesztelési Terv

### 1. Helyi Fejlesztés
```bash
# Mock API hívás
POST http://localhost:3000/api/generate-workbook
{ "result_id": "test-uuid-123" }

# Ellenőrzés:
✓ 2 GPT-5 hívás megtörtént?
✓ 30 nap generálódott?
✓ PDF 37-40 oldal?
✓ Meditációk benne vannak?
```

### 2. Stripe Teszt Vásárlás
```bash
# Test card: 4242 4242 4242 4242
# Product: workbook_30day (3,990 HUF)

Ellenőrzés:
✓ Webhook triggerelte /api/generate-workbook?
✓ purchases táblában pdf_url NULL → kitöltődik?
✓ Success page polling működik?
✓ PDF letölthető?
```

### 3. Edge Case-ek
```
✓ Minden csakra blokkolt (7× score ≤7)
✓ Minden csakra egészséges (7× score ≥13)
✓ GPT-5 timeout/error → retry?
✓ Upload error → 3× retry?
✓ Polling timeout (3 perc) → error message?
```

---

## 📊 Személyre Szabás Példa

### Input (User Quiz Results)
```json
{
  "Gyökércsakra": 6,        // BLOKKOLT
  "Szakrális csakra": 11,   // KIEGYENSÚLYOZATLAN
  "Napfonat csakra": 8,     // KIEGYENSÚLYOZATLAN
  "Szív csakra": 14,        // EGÉSZSÉGES
  "Torok csakra": 7,        // BLOKKOLT
  "Harmadik szem": 10,      // KIEGYENSÚLYOZATLAN
  "Korona csakra": 15       // EGÉSZSÉGES
}
```

### Output (Nap Elosztás)
```
Gyökércsakra:    Nap 1-6   (6 nap - blokkolt, score 6)
Szakrális:       Nap 7-11  (5 nap - kiegyensúlyozatlan)
Napfonat:        Nap 12-16 (5 nap - kiegyensúlyozatlan)
Szív:            Nap 17-19 (3 nap - egészséges)
Torok:           Nap 20-25 (6 nap - blokkolt, score 7)
Harmadik szem:   Nap 26-29 (4 nap - kiegyensúlyozatlan)
Korona:          Nap 30    (1 nap - egészséges)

TOTAL: 30 nap ✓
```

### Bevezető Oldal Személyre Szabása
```
Kedves Anna!

Az általad kitöltött teszt alapján a Gyökércsakrád (6 pont)
és a Torok csakrád (7 pont) különösen figyelmet igényel.
Ez a 30 napos program ezért több időt szentel ezeknek a
területeknek - 6-6 napot gyakorlásra és elmélyülésre.

A Szív csakrád és a Korona csakrád viszont egészséges
egyensúlyban van (14 és 15 pont), így ezeken a területeken
fenntartó gyakorlatokat kapsz.

Az elkövetkező 30 napban naponta kapsz egy személyre szabott
gyakorlatot, journaling kérdéseket és affirmációkat...
```

---

## ✅ Sikerességi Kritériumok

### Funkcionális
- [ ] Vásárláskor automatikus generálás
- [ ] 30 nap személyre szabott tartalom
- [ ] Csakra elosztás score alapján
- [ ] 7 meditációs script PDF-ben
- [ ] Success page polling működik
- [ ] PDF letölthető 30 napos signed URL-lel

### Teljesítmény
- [ ] Generálás <60 másodperc
- [ ] PDF méret <5 MB
- [ ] Token költség <$0.10/workbook
- [ ] Upload retry működik (max 3×)

### Minőség
- [ ] 100% magyar nyellang
- [ ] Tegező forma
- [ ] Nincs OpenAI hiba (Zod validation)
- [ ] PDF olvasható, szép formázás
- [ ] Meditációs scriptek helyesek

---

## 📦 Deployment

### Environment Variables (már meglévők)
```bash
OPENAI_API_KEY=sk-proj-xxx
NEXT_PUBLIC_SUPABASE_URL=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
STRIPE_PRODUCT_ID_WORKBOOK=prod_xxx
STRIPE_PRICE_ID_WORKBOOK=price_xxx
```

### Supabase Setup
1. Create `workbooks` storage bucket
2. RLS policies: public read + service upload
3. Test upload/download manually

### Stripe Setup
1. Product exists: workbook_30day (3,990 HUF)
2. Webhook active: /api/stripe/webhook
3. Test mode validation

---

## 🚀 Implementation Roadmap

### Phase 1: Core Generation (Day 1)
- [x] Create v2.5 documentation
- [ ] `workbook-generator-gpt5.ts`
- [ ] `workbook-prompts-gpt5.ts`
- [ ] `workbook-schemas-gpt5.ts`
- [ ] Basic API route `/api/generate-workbook`

### Phase 2: PDF Generation (Day 1-2)
- [ ] `workbook-template-gpt5.ts`
- [ ] Day page layout
- [ ] Cover + Introduction pages
- [ ] Meditation script pages
- [ ] Closing page

### Phase 3: Integration (Day 2)
- [ ] Webhook modification
- [ ] DownloadLinks component update
- [ ] Supabase storage bucket setup
- [ ] Local testing

### Phase 4: Testing & Deployment (Day 2-3)
- [ ] Local generation test
- [ ] Stripe test purchase
- [ ] Edge case testing
- [ ] Production deployment
- [ ] Live user test

---

## 📝 Notes & Assumptions

### Assumptions
- GPT-5-mini API stable (no rate limits hit)
- @react-pdf/renderer handles 40-page PDFs
- Supabase storage allows 5MB+ files
- Vercel function timeout sufficient (180s default)
- Hungarian text wrapping works with existing safeTextWrap()

### Known Limitations
- No retry for GPT-5 API calls (fail fast)
- No progress tracking during generation
- User can't customize day distribution
- Fixed meditation scripts (not personalized)
- No email notification when PDF ready

### Future Enhancements (v2.6+)
- Progress bar during generation
- Email delivery when PDF ready
- Customizable day length (15/30/60 days)
- Meditation audio integration (not just text)
- Weekly review pages (optional toggle)
- Printable version (optimized layout)

---

**Document Version:** 1.0
**Last Updated:** 2025-10-22
**Status:** ✅ Approved - Implementation Starting
