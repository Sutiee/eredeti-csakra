# V2.5 - 30 Napos Csakra MunkafÃ¼zet GenerÃ¡lÃ¡s

**Created:** 2025-10-22
**Status:** Implementation Phase
**Goal:** SzemÃ©lyre szabott 30 napos munkafÃ¼zet generÃ¡lÃ¡sa GPT-5-mini + PDF-el vÃ¡sÃ¡rlÃ¡skor

---

## ğŸ“‹ Feature Overview

### TermÃ©k: 30 Napos Csakra MunkafÃ¼zet
- **Ãr:** 3,990 HUF (eredeti 9,990 HUF, 60% kedvezmÃ©ny)
- **Tartalom:** 30-40 oldalas PDF szemÃ©lyre szabott gyakorlatokkal
- **GenerÃ¡lÃ¡s:** VÃ¡sÃ¡rlÃ¡skor automatikusan (Stripe webhook trigger)
- **TechnolÃ³gia:** GPT-5-mini (2 API hÃ­vÃ¡s) + @react-pdf/renderer
- **Delivery:** Success page-en polling-al, PDF download link

---

## ğŸ¯ DÃ¶ntÃ©sek (User Ã¡ltal jÃ³vÃ¡hagyva)

### 1. Csakra ElosztÃ¡s
**OpciÃ³ B - SzemÃ©lyre szabott (user score alapjÃ¡n)**
- Blokkolt csakrÃ¡k (score 4-7): **6-7 nap**
- KiegyensÃºlyozatlan (score 8-12): **4-5 nap**
- EgÃ©szsÃ©ges (score 13-16): **2-3 nap**

### 2. Napi Tartalom
**OpciÃ³ B - Gazdag verziÃ³ (20-30 perc/nap)**
```
âœ“ Nap szÃ¡ma + csakra (szÃ­nes fejlÃ©c)
âœ“ Napi szÃ¡ndÃ©k/fÃ³kusz (1 mondat)
âœ“ ElmÃ©leti hÃ¡ttÃ©r (MIÃ‰RT fontos - 2-3 mondat)
âœ“ RÃ©szletes gyakorlat (4-5 lÃ©pÃ©s: HOL, MIKOR, HOGYAN)
âœ“ 3-5 journaling kÃ©rdÃ©s (Ã¶nreflexiÃ³)
âœ“ AffirmÃ¡ciÃ³k (2-3 mondat)
âœ“ MotivÃ¡ciÃ³s zÃ¡rÃ¡s
```

### 3. Heti Ã‰rtÃ©kelÃ©s
**OpciÃ³ C - Folyamatos tracking**
- Minden napi oldalon checkbox (â˜ MegtÃ¶rtÃ©nt)
- Nincs kÃ¼lÃ¶n heti Ã©rtÃ©kelÅ‘ lap
- User maga Ã¶sszegzi heti szinten

### 4. PersonalizÃ¡ciÃ³
**Szint 2 - KÃ¶zepesen szemÃ©lyre szabott**
- Nap-elosztÃ¡s szemÃ©lyre szabott (tÃ¶bb nap blokkolt csakrÃ¡knak)
- BevezetÅ‘ oldal utal user score-ra
- Gyakorlatok Ã¡ltalÃ¡nosak, de hangsÃºlyok eltÃ©rnek
- Gyorsabb generÃ¡lÃ¡s, kevesebb token

### 5. GPT-5 StratÃ©gia
**OpciÃ³ B - KÃ©t API hÃ­vÃ¡s**
- 1. hÃ­vÃ¡s: Nap 1-15
- 2. hÃ­vÃ¡s: Nap 16-30
- KÃ¶ltsÃ©g: ~$0.08-0.10/munkafÃ¼zet
- GenerÃ¡lÃ¡si idÅ‘: ~48-50 mÃ¡sodperc

### 6. MeditÃ¡ciÃ³k
**OpciÃ³ A - PDF-ben teljes script**
- Minden csakrÃ¡nÃ¡l teljes 15-20 perces meditÃ¡ciÃ³s szÃ¶veg
- +7 oldal (Ã¶sszesen 37-40 oldal PDF)
- ÃšjrafelhasznÃ¡lÃ¡s: `data/meditation-scripts.ts`

### 7. Ãr & Bundle
**3,990 HUF - NINCS bundle**
- Standalone termÃ©k
- Upsell sorrend: 990 Ft AI ElemzÃ©s â†’ 3,990 Ft MunkafÃ¼zet
- MeditÃ¡ciÃ³k kÃ¼lÃ¶n termÃ©k (kÃ©sÅ‘bb)

---

## ğŸ—ï¸ ArchitektÃºra

### Data Flow
```
User vÃ¡sÃ¡rol (Stripe)
    â†“
Webhook trigger â†’ POST /api/generate-workbook
    â†“
1. Fetch quiz_results (csakra score-ok)
    â†“
2. Calculate personalized day distribution
    â†“
3. GPT-5 hÃ­vÃ¡s #1: Nap 1-15 generÃ¡lÃ¡s (~20s)
    â†“
4. GPT-5 hÃ­vÃ¡s #2: Nap 16-30 generÃ¡lÃ¡s (~20s)
    â†“
5. Combine results + add meditation scripts
    â†“
6. Generate PDF with @react-pdf/renderer (~5s)
    â†“
7. Upload to Supabase Storage (workbooks bucket)
    â†“
8. Create signed URL (30 days expiry)
    â†“
9. Update purchases.pdf_url
    â†“
Success page: polling â†’ Download gomb megjelenik
```

### Token Usage (per workbook)
```
Input:  6,000 tokens (~$0.003)
Output: 8,000 tokens (~$0.08)
TOTAL:  ~$0.083/workbook
```

### Generation Time
```
1. Fetch quiz result:          ~500ms
2. GPT-5 #1 (Days 1-15):        ~20s
3. GPT-5 #2 (Days 16-30):       ~20s
4. PDF generation:              ~5s
5. Upload + signed URL:         ~3s
TOTAL:                          ~48-50s
```

---

## ğŸ“ Ãšj FÃ¡jlok (7 db)

### 1. `lib/openai/workbook-generator-gpt5.ts`
**FelelÅ‘ssÃ©g:** GPT-5 orchestration
```typescript
- generateWorkbookContent(chakraScores, userName)
- generateWorkbookDays1to15()
- generateWorkbookDays16to30()
- calculateDaysPerChakra(chakraScores)
- combineDayContent()
```

### 2. `lib/openai/workbook-prompts-gpt5.ts`
**FelelÅ‘ssÃ©g:** Prompt builders
```typescript
- buildWorkbookPrompt(chakraScores, userName, dayRange, distribution)
```

### 3. `lib/openai/workbook-schemas-gpt5.ts`
**FelelÅ‘ssÃ©g:** Zod validation
```typescript
- WorkbookDaySchema
- WorkbookDaysResponseSchema (15 days)
- Type exports: WorkbookDay, WorkbookDaysResponse
```

### 4. `lib/pdf/workbook-template-gpt5.ts`
**FelelÅ‘ssÃ©g:** PDF generation
```typescript
- generateWorkbookPDF(days, chakraScores, userName, meditations)
- addCoverPage()
- addIntroductionPage()
- addDayPage(day)
- addMeditationScriptPage(chakra)
- addClosingPage()
```

### 5. `app/api/generate-workbook/route.ts`
**FelelÅ‘ssÃ©g:** API endpoint
```typescript
POST /api/generate-workbook
Input: { result_id: string }
Output: { data: { success, pdf_url }, error }
```

### 6. `supabase/migrations/00X_workbooks_bucket.sql`
**FelelÅ‘ssÃ©g:** Storage setup
```sql
- Create workbooks bucket
- RLS policies (public read, service upload)
```

### 7. `docs/V2.5_WORKBOOK_30DAY_PLAN.md` âœ…
**FelelÅ‘ssÃ©g:** Ez a dokumentum

---

## ğŸ”§ MÃ³dosÃ­tott FÃ¡jlok (2 db)

### 1. `app/api/stripe/webhook/route.ts`
**VÃ¡ltozÃ¡s:** +10 sor (workbook trigger)
```typescript
// Line 151 utÃ¡n:
if (productId === 'workbook_30day') {
  fetch(`${SITE_URL}/api/generate-workbook`, {
    method: 'POST',
    body: JSON.stringify({ result_id: resultId }),
  });
}
```

### 2. `components/success/DownloadLinks.tsx`
**VÃ¡ltozÃ¡s:** +15 sor (workbook polling + display)
```typescript
// hasGeneratingPDFs check:
const hasGeneratingPDFs = purchases.some(
  (p) => (p.product_id === 'ai_analysis_pdf' || p.product_id === 'workbook_30day') && !p.pdf_url
);

// PDF display:
if (purchase.product_id === 'workbook_30day' && purchase.pdf_url) {
  return <a href={purchase.pdf_url}>ğŸ“– 30 Napos MunkafÃ¼zet letÃ¶ltÃ©se</a>;
}
```

---

## ğŸ“– PDF StruktÃºra (37-40 oldal)

```
Oldal 1:    BorÃ­tÃ³ (CÃ­m, User neve, DÃ¡tum)
Oldal 2:    BevezetÅ‘ (SzemÃ©lyre szabott Ã¼zenet score alapjÃ¡n)
Oldal 3-32: Napi oldalak (30 nap Ã— gyakorlatok)
Oldal 33:   GyÃ¶kÃ©rcsakra meditÃ¡ciÃ³s script
Oldal 34:   SzakrÃ¡lis csakra meditÃ¡ciÃ³s script
Oldal 35:   Napfonat csakra meditÃ¡ciÃ³s script
Oldal 36:   SzÃ­v csakra meditÃ¡ciÃ³s script
Oldal 37:   Torok csakra meditÃ¡ciÃ³s script
Oldal 38:   Harmadik szem meditÃ¡ciÃ³s script
Oldal 39:   Korona csakra meditÃ¡ciÃ³s script
Oldal 40:   ZÃ¡rÃ³ oldal (GratulÃ¡lÃ¡s, KÃ¶vetkezÅ‘ lÃ©pÃ©sek)
```

### Napi Oldal Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Csakra SzÃ­nes CsÃ­k]                â”‚
â”‚ 15. NAP - TOROK CSAKRA              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¯ Napi SzÃ¡ndÃ©k:                    â”‚
â”‚ "Ma megtanulom hitelesen..."        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ MiÃ©rt fontos?                    â”‚
â”‚ "A Torok csakra a hitelessÃ©g..."    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ¨ Mai Gyakorlat:                   â”‚
â”‚ 1. Reggel felkelve...               â”‚
â”‚ 2. Munka kÃ¶zben...                  â”‚
â”‚ 3. Este lefekvÃ©s elÅ‘tt...           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Journaling KÃ©rdÃ©sek:             â”‚
â”‚ â€¢ Mikor hallgattam el magam?        â”‚
â”‚ â€¢ Mit szeretnÃ©k kimondani?          â”‚
â”‚ â€¢ Hogyan Ã©reztem magam...?          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¬ Napi AffirmÃ¡ciÃ³:                 â”‚
â”‚ "Szabadon Ã©s hitelesen kifejezem    â”‚
â”‚  magam. A hangom fontos."           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ Reggeli gyakorlat elvÃ©gezve       â”‚
â”‚ â˜ Journaling befejezve              â”‚
â”‚ â˜ AffirmÃ¡ciÃ³ 3Ã— elmondva            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒŸ "EmlÃ©kezz: minden szavad szÃ¡mÃ­t" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª TesztelÃ©si Terv

### 1. Helyi FejlesztÃ©s
```bash
# Mock API hÃ­vÃ¡s
POST http://localhost:3000/api/generate-workbook
{ "result_id": "test-uuid-123" }

# EllenÅ‘rzÃ©s:
âœ“ 2 GPT-5 hÃ­vÃ¡s megtÃ¶rtÃ©nt?
âœ“ 30 nap generÃ¡lÃ³dott?
âœ“ PDF 37-40 oldal?
âœ“ MeditÃ¡ciÃ³k benne vannak?
```

### 2. Stripe Teszt VÃ¡sÃ¡rlÃ¡s
```bash
# Test card: 4242 4242 4242 4242
# Product: workbook_30day (3,990 HUF)

EllenÅ‘rzÃ©s:
âœ“ Webhook triggerelte /api/generate-workbook?
âœ“ purchases tÃ¡blÃ¡ban pdf_url NULL â†’ kitÃ¶ltÅ‘dik?
âœ“ Success page polling mÅ±kÃ¶dik?
âœ“ PDF letÃ¶lthetÅ‘?
```

### 3. Edge Case-ek
```
âœ“ Minden csakra blokkolt (7Ã— score â‰¤7)
âœ“ Minden csakra egÃ©szsÃ©ges (7Ã— score â‰¥13)
âœ“ GPT-5 timeout/error â†’ retry?
âœ“ Upload error â†’ 3Ã— retry?
âœ“ Polling timeout (3 perc) â†’ error message?
```

---

## ğŸ“Š SzemÃ©lyre SzabÃ¡s PÃ©lda

### Input (User Quiz Results)
```json
{
  "GyÃ¶kÃ©rcsakra": 6,        // BLOKKOLT
  "SzakrÃ¡lis csakra": 11,   // KIEGYENSÃšLYOZATLAN
  "Napfonat csakra": 8,     // KIEGYENSÃšLYOZATLAN
  "SzÃ­v csakra": 14,        // EGÃ‰SZSÃ‰GES
  "Torok csakra": 7,        // BLOKKOLT
  "Harmadik szem": 10,      // KIEGYENSÃšLYOZATLAN
  "Korona csakra": 15       // EGÃ‰SZSÃ‰GES
}
```

### Output (Nap ElosztÃ¡s)
```
GyÃ¶kÃ©rcsakra:    Nap 1-6   (6 nap - blokkolt, score 6)
SzakrÃ¡lis:       Nap 7-11  (5 nap - kiegyensÃºlyozatlan)
Napfonat:        Nap 12-16 (5 nap - kiegyensÃºlyozatlan)
SzÃ­v:            Nap 17-19 (3 nap - egÃ©szsÃ©ges)
Torok:           Nap 20-25 (6 nap - blokkolt, score 7)
Harmadik szem:   Nap 26-29 (4 nap - kiegyensÃºlyozatlan)
Korona:          Nap 30    (1 nap - egÃ©szsÃ©ges)

TOTAL: 30 nap âœ“
```

### BevezetÅ‘ Oldal SzemÃ©lyre SzabÃ¡sa
```
Kedves Anna!

Az Ã¡ltalad kitÃ¶ltÃ¶tt teszt alapjÃ¡n a GyÃ¶kÃ©rcsakrÃ¡d (6 pont)
Ã©s a Torok csakrÃ¡d (7 pont) kÃ¼lÃ¶nÃ¶sen figyelmet igÃ©nyel.
Ez a 30 napos program ezÃ©rt tÃ¶bb idÅ‘t szentel ezeknek a
terÃ¼leteknek - 6-6 napot gyakorlÃ¡sra Ã©s elmÃ©lyÃ¼lÃ©sre.

A SzÃ­v csakrÃ¡d Ã©s a Korona csakrÃ¡d viszont egÃ©szsÃ©ges
egyensÃºlyban van (14 Ã©s 15 pont), Ã­gy ezeken a terÃ¼leteken
fenntartÃ³ gyakorlatokat kapsz.

Az elkÃ¶vetkezÅ‘ 30 napban naponta kapsz egy szemÃ©lyre szabott
gyakorlatot, journaling kÃ©rdÃ©seket Ã©s affirmÃ¡ciÃ³kat...
```

---

## âœ… SikeressÃ©gi KritÃ©riumok

### FunkcionÃ¡lis
- [ ] VÃ¡sÃ¡rlÃ¡skor automatikus generÃ¡lÃ¡s
- [ ] 30 nap szemÃ©lyre szabott tartalom
- [ ] Csakra elosztÃ¡s score alapjÃ¡n
- [ ] 7 meditÃ¡ciÃ³s script PDF-ben
- [ ] Success page polling mÅ±kÃ¶dik
- [ ] PDF letÃ¶lthetÅ‘ 30 napos signed URL-lel

### TeljesÃ­tmÃ©ny
- [ ] GenerÃ¡lÃ¡s <60 mÃ¡sodperc
- [ ] PDF mÃ©ret <5 MB
- [ ] Token kÃ¶ltsÃ©g <$0.10/workbook
- [ ] Upload retry mÅ±kÃ¶dik (max 3Ã—)

### MinÅ‘sÃ©g
- [ ] 100% magyar nyellang
- [ ] TegezÅ‘ forma
- [ ] Nincs OpenAI hiba (Zod validation)
- [ ] PDF olvashatÃ³, szÃ©p formÃ¡zÃ¡s
- [ ] MeditÃ¡ciÃ³s scriptek helyesek

---

## ğŸ“¦ Deployment

### Environment Variables (mÃ¡r meglÃ©vÅ‘k)
```bash
OPENAI_API_KEY=sk-proj-xxx
NEXT_PUBLIC_SUPABASE_URL=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
STRIPE_PRODUCT_ID_WORKBOOK=prod_xxx
STRIPE_PRICE_ID_WORKBOOK=price_xxx
```

### Supabase Setup
1. Create `workbooks` storage bucket
2. RLS policies: public read + service upload
3. Test upload/download manually

### Stripe Setup
1. Product exists: workbook_30day (3,990 HUF)
2. Webhook active: /api/stripe/webhook
3. Test mode validation

---

## ğŸš€ Implementation Roadmap

### Phase 1: Core Generation (Day 1)
- [x] Create v2.5 documentation
- [ ] `workbook-generator-gpt5.ts`
- [ ] `workbook-prompts-gpt5.ts`
- [ ] `workbook-schemas-gpt5.ts`
- [ ] Basic API route `/api/generate-workbook`

### Phase 2: PDF Generation (Day 1-2)
- [ ] `workbook-template-gpt5.ts`
- [ ] Day page layout
- [ ] Cover + Introduction pages
- [ ] Meditation script pages
- [ ] Closing page

### Phase 3: Integration (Day 2)
- [ ] Webhook modification
- [ ] DownloadLinks component update
- [ ] Supabase storage bucket setup
- [ ] Local testing

### Phase 4: Testing & Deployment (Day 2-3)
- [ ] Local generation test
- [ ] Stripe test purchase
- [ ] Edge case testing
- [ ] Production deployment
- [ ] Live user test

---

## ğŸ“ Notes & Assumptions

### Assumptions
- GPT-5-mini API stable (no rate limits hit)
- @react-pdf/renderer handles 40-page PDFs
- Supabase storage allows 5MB+ files
- Vercel function timeout sufficient (180s default)
- Hungarian text wrapping works with existing safeTextWrap()

### Known Limitations
- No retry for GPT-5 API calls (fail fast)
- No progress tracking during generation
- User can't customize day distribution
- Fixed meditation scripts (not personalized)
- No email notification when PDF ready

### Future Enhancements (v2.6+)
- Progress bar during generation
- Email delivery when PDF ready
- Customizable day length (15/30/60 days)
- Meditation audio integration (not just text)
- Weekly review pages (optional toggle)
- Printable version (optimized layout)

---

**Document Version:** 1.0
**Last Updated:** 2025-10-22
**Status:** âœ… Approved - Implementation Starting
